name: Daily Organization Package Cleanup

on:
  push:
    branches:
      - main
  workflow_dispatch:     # Allows manual trigger from GitHub UI

permissions:
  contents: read
  packages: write
  actions: read

jobs:
  cleanup-organization-packages:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Delete old package versions for all packages
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            
            // List all packages for authenticated user
            const packagesResponse = await github.rest.packages.listPackagesForAuthenticatedUser({
              package_type: 'container'
            });
            
            for (const pkg of packagesResponse.data) {
              console.log(`Processing package: ${pkg.name}`);
              
              const versionsResponse = await github.rest.packages.getAllPackageVersionsForPackageOwnedByAuthenticatedUser({
                package_type: 'container',
                package_name: pkg.name
              });
              
              const versions = versionsResponse.data.sort((a, b) => 
                new Date(b.created_at) - new Date(a.created_at)
              );
              
              const versionsToDelete = versions.slice(2); // Keep 2 most recent
              
              for (const version of versionsToDelete) {
                console.log(`Deleting version ${version.id} of ${pkg.name}`);
                await github.rest.packages.deletePackageVersionForAuthenticatedUser({
                  package_type: 'container',
                  package_name: pkg.name,
                  package_version_id: version.id
                });
              }
            }