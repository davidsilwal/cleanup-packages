name: Daily Organization Package Cleanup

on:
  schedule:
    - cron: '0 0 */3 * *'  # Runs every 3 days at midnight UTC
  workflow_dispatch:       # Allows manual trigger from GitHub UI

permissions:
  contents: read
  packages: write
  actions: read

jobs:
  cleanup-organization-packages:
    runs-on: ubuntu-latest
    environment: PAT_TOKEN
    steps:
      - name: Delete old package versions for all packages
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            const owner = context.repo.owner;
            
            // List all packages for user
            const packagesResponse = await github.rest.packages.listPackagesForUser({
              package_type: 'container',
              username: owner,
              visibility: 'private'
            });
            
            for (const pkg of packagesResponse.data) {
              console.log(`Processing package: ${pkg.name}`);
              
              const versionsResponse = await github.rest.packages.getAllPackageVersionsForPackageOwnedByUser({
                package_type: 'container',
                package_name: pkg.name,
                username: owner
              });
              
              const versions = versionsResponse.data.sort((a, b) => 
                new Date(b.created_at) - new Date(a.created_at)
              );
              
              const versionsToDelete = versions.slice(2); // Keep 2 most recent
              
              for (const version of versionsToDelete) {
                console.log(`Deleting version ${version.id} of ${pkg.name}`);
                await github.rest.packages.deletePackageVersionForUser({
                  package_type: 'container',
                  package_name: pkg.name,
                  username: owner,
                  package_version_id: version.id
                });
              }
            }